<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…Ø³Ù„Ø®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø§Øª Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap');
        
        :root {
            --header-footer-color: #A0522D;
            --header-height: 60px;
            --footer-height: 20px;
            --sidebar-width: 220px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .loading-spinner {
            border-top: 4px solid #f3f3f3;
            border-right: 4px solid #f3f3f3;
            border-bottom: 4px solid #f3f3f3;
            border-left: 4px solid #fff;
            transform: translateZ(0);
            animation: spin 1s infinite linear;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .app-button {
            padding: 1rem 1.5rem;
            font-size: 1.125rem;
            font-weight: 700;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .app-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        #main-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-top: var(--header-height);
            padding-bottom: var(--footer-height);
        }
        
        #app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background-color: var(--header-footer-color);
            color: white;
            z-index: 20;
        }
        
        #app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--footer-height);
            background-color: var(--header-footer-color);
            color: white;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
        }
        
        #app-content {
            flex-grow: 1;
            display: flex;
            background-color: #f7f9fb;
        }
        
        #sidebar {
            width: var(--sidebar-width);
            flex-shrink: 0;
            padding: 1rem;
            background-color: white;
            border-left: 1px solid #e5e7eb;
        }
        
        #screen-container {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .color-0-5 { background-color: rgba(239, 68, 68, 0.3); }
        .color-1 { background-color: rgba(210, 180, 140, 0.5); }
        .color-1-5 { background-color: rgba(144, 238, 144, 0.5); }
        .color-2 { background-color: rgba(152, 251, 152, 0.5); }
        .color-2-5 { background-color: rgba(0, 128, 0, 0.3); }
        .color-na { background-color: #f3f4f6; color: #6b7280; }

        .table-input {
            width: 100%;
            height: 100%;
            padding: 0.25rem;
            font-weight: 700;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .table-input:focus {
            border-color: #3b82f6;
            outline: none;
        }
        
        .table-input:disabled {
            background-color: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }
        
        .table-cell-header {
            min-width: 80px;
            white-space: normal !important;
            word-wrap: break-word;
            padding: 8px 6px;
            font-weight: 600;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .cleaning-score-select-table {
            width: 100%;
            height: 100%;
            padding: 0.25rem;
            font-weight: 700;
            text-align: center;
            border: none;
            cursor: pointer;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            font-size: 0.8rem;
        }
        
        .cleaning-score-select-table:focus {
            outline: 2px solid #3b82f6;
        }
        
        @media print {
            body > * { display: none !important; }
            #print-container { 
                display: block !important;
                direction: rtl;
                padding: 20px;
                margin: 0;
                font-family: 'Cairo', sans-serif !important;
                width: 100% !important;
            }
            
            @page {
                size: landscape;
                margin: 0.5cm 0cm 1cm 0cm;
            }
            
            #print-container .app-button,
            #print-container select,
            #print-container input[type="file"],
            #print-container .delete-point,
            #print-container .delete-admin,
            #print-container .approve-day-button,
            #print-container .new-lab-input,
            #print-container #addLabReport,
            #print-container .accordion-toggle,
            #print-container .delete-lab-button,
            #print-container .edit-lab-button,
            #print-container .delete-day-button,
            #print-container .table-input,
            #print-container .cleaning-score-select-table,
            #print-container .flexible-input,
            #print-container #cleaning-month-filter,
            #print-container #temp-month-filter,
            #print-container #maint-month-filter,
            #print-container #lab-date-filter,
            #print-container #lab-date-start,
            #print-container #lab-date-end { 
                display: none !important;
            } 
            
            #print-container table { 
                width: 100%; 
                border-collapse: collapse; 
                margin: 15px 0;
                font-size: 14px;
            }
            
            #print-container th, #print-container td { 
                border: 1px solid #000 !important; 
                padding: 8px 5px;
                text-align: center;
                vertical-align: middle;
            }
            
            #print-container thead { 
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .color-0-5, .color-1, .color-1-5, .color-2, .color-2-5, .color-na {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            #print-container .empty-row {
                display: none !important;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 2px solid #333;
            }
            
            .print-header h1 {
                font-size: 28px;
                font-weight: bold;
                margin: 0;
                color: #333;
            }
            
            .print-header h2 {
                font-size: 22px;
                margin: 10px 0;
                color: #555;
            }
            
            .print-header h3 {
                font-size: 18px;
                margin: 5px 0;
                color: #777;
            }
            
            .print-stats {
                margin: 20px 0;
                padding: 15px;
                background-color: #f9f9f9;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            
            .print-stats h3 {
                font-size: 18px;
                margin: 0 0 15px 0;
                text-align: center;
                font-weight: bold;
            }
            
            #print-container .lab-table-container,
            #print-container .overflow-x-auto,
            #print-container .overflow-y-auto {
                overflow: visible !important;
                max-height: none !important;
            }
            
            #print-container * {
                box-shadow: none !important;
                text-shadow: none !important;
            }

            .print-section {
                margin: 25px 0;
                page-break-inside: avoid;
            }

            .print-divider {
                border-top: 2px solid #333;
                margin: 20px 0;
                padding-top: 15px;
            }

            /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
            .cleaning-report-title {
                text-align: center;
                margin-bottom: 15px;
                font-size: 20px;
                font-weight: bold;
            }
            
            .cleaning-report-abattoir {
                text-align: right;
                float: right;
                font-size: 14px;
                font-weight: bold;
            }
            
            .cleaning-report-date {
                text-align: left;
                float: left;
                font-size: 14px;
                font-weight: bold;
            }
            
            .temperature-report-title {
                text-align: center;
                margin-bottom: 15px;
                font-size: 20px;
                font-weight: bold;
            }
            
            .temperature-report-abattoir {
                text-align: right;
                float: right;
                font-size: 14px;
                font-weight: bold;
            }
            
            .temperature-report-date {
                text-align: left;
                float: left;
                font-size: 14px;
                font-weight: bold;
            }
            
            .lab-report-title {
                text-align: center;
                margin-bottom: 15px;
                font-size: 20px;
                font-weight: bold;
            }
            
            .lab-report-abattoir {
                text-align: left;
                float: left;
                font-size: 14px;
                font-weight: bold;
            }
            
            .lab-report-date {
                text-align: right;
                float: right;
                font-size: 14px;
                font-weight: bold;
            }
            
            .rotate-header {
                writing-mode: vertical-rl;
                text-orientation: mixed;
                transform: rotate(180deg);
                white-space: nowrap;
                padding: 10px 5px;
                font-size: 12px;
                font-weight: bold;
            }
            
            .cleaning-legend-print {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 15px;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 5px;
                font-size: 13px;
                page-break-inside: avoid;
            }
            
            .legend-item-print {
                display: flex;
                align-items: center;
                margin: 0 5px;
            }
            
            .legend-color-print {
                width: 20px;
                height: 20px;
                margin-left: 5px;
                border-radius: 3px;
            }
            
            /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ© */
            .lab-stats-compact {
                margin-top: 10px;
                padding: 8px;
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                font-size: 13px;
                line-height: 1.2;
            }
            
            .lab-stats-compact h4 {
                font-size: 14px;
                font-weight: bold;
                margin: 0 0 5px 0;
                text-align: center;
            }
            
            .lab-stats-compact .stats-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 2px;
            }
            
            .lab-stats-compact .stats-section {
                margin-bottom: 5px;
            }
            
            /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ±Ø© */
            .stats-tables-container {
                display: flex;
                justify-content: space-between;
                gap: 5px;
                margin-top: 10px;
            }
            
            .stats-table {
                flex: 1;
                border-collapse: collapse;
                font-size: 12px;
            }
            
            .stats-table th, .stats-table td {
                border: 1px solid #000;
                padding: 4px 3px;
                text-align: center;
            }
            
            .stats-table th {
                background-color: #f0f0f0;
                font-weight: bold;
            }
            
            .stats-table-title {
                text-align: center;
                font-weight: bold;
                margin-bottom: 5px;
                font-size: 13px;
            }
        }

        .flexible-cell {
            min-height: 40px;
            height: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            padding: 4px;
            text-align: center;
            vertical-align: middle;
        }
        
        .flexible-input {
            width: 100%;
            min-height: 40px;
            height: auto;
            resize: vertical;
            padding: 4px;
            font-weight: 700;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .lab-date-picker {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
            width: 100%;
            text-align: center;
        }
        
        .lab-table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .lab-table th {
            position: sticky;
            top: 0;
            background-color: #f8fafc;
            z-index: 10;
        }

        .cleaning-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-left: 5px;
            border-radius: 3px;
        }
        
        .approved-report {
            background-color: rgba(34, 197, 94, 0.1) !important;
        }
        
        .approved-cell {
            background-color: rgba(34, 197, 94, 0.2) !important;
        }
        
        .horizontal-report {
            width: 100%;
            overflow-x: auto;
        }
        
        .horizontal-table {
            min-width: 100%;
            table-layout: fixed;
        }
        
        .empty-row {
            display: none;
        }

        .temperature-period-header {
            font-weight: 600;
            font-size: 0.75rem;
            white-space: nowrap;
            padding: 8px 4px;
        }
        
        .temperature-point-header {
            font-weight: 500;
            font-size: 0.7rem;
            white-space: normal;
            line-height: 1.1;
            padding: 6px 3px;
            min-width: 60px;
        }

        .maintenance-point-header {
            min-width: 120px;
            white-space: normal;
            line-height: 1.2;
            padding: 8px 6px;
        }

        @media (max-width: 768px) {
            #app-content {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                order: 2;
                padding: 0.5rem;
            }
            
            #screen-container {
                order: 1;
                padding: 1rem;
            }
            
            .app-button {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

    <div id="splash-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 transition-opacity duration-500 opacity-100">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…Ø³Ù„Ø®</h1>
        <img id="splash-image-display" src="" alt="ØµÙˆØ±Ø© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨" class="rounded-lg shadow-xl mb-8 w-96 h-48 object-cover">
        <div class="loading-spinner h-10 w-10 rounded-full border-8"></div>
        <p class="mt-4 text-gray-600">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <div id="login-screen" class="hidden fixed inset-0 bg-gray-100 flex items-center justify-center z-40">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <div class="mb-4">
                <label for="abattoirCode" class="block text-gray-700 font-semibold mb-2">Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ù„Ø®</label>
                <input type="text" id="abattoirCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-lg font-mono text-center" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ù„Ø®">
            </div>
            <p id="loginMessage" class="text-red-500 text-sm mb-4 hidden">Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ù„Ø® ØºÙŠØ± ØµØ­ÙŠØ­.</p>
            <button id="loginButton" class="w-full p-3 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition duration-150 flex items-center justify-center">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                <div id="loginLoading" class="hidden loading-spinner h-5 w-5 rounded-full border-4 mr-2"></div>
            </button>
        </div>
    </div>

    <div id="main-layout" class="hidden">
        
        <header id="app-header" class="flex flex-col justify-center items-center p-4 shadow-lg">
            <div class="flex justify-between items-center w-full max-w-6xl mx-auto">
                <h1 class="text-3xl font-extrabold">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="text-sm font-semibold text-white ml-4 text-right">
                        <p id="headerAbattoirName">Ù…Ø³Ù„Ø®</p>
                        <p class="text-xs text-gray-200" id="headerAbattoirCode">N/A</p>
                    </div>
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </header>

        <div id="app-content">
            
            <aside id="sidebar" class="hidden lg:block">
                <img id="sidebar-image-display" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³Ù„Ø® Ø§Ù„Ù…ÙˆØ­Ø¯Ø©" class="w-full h-auto rounded-lg shadow-md mb-4">
                <nav class="mt-8 space-y-4">
                    <button data-screen="dashboard" class="menu-item w-full text-right p-3 rounded-lg hover:bg-gray-100 transition duration-150 font-semibold text-gray-700">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                    <button data-screen="cleaning" class="menu-item w-full text-right p-3 rounded-lg hover:bg-gray-100 transition duration-150 text-gray-700">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¸Ø§ÙØ©</button>
                    <button data-screen="temperature" class="menu-item w-full text-right p-3 rounded-lg hover:bg-gray-100 transition duration-150 text-gray-700">Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø©</button>
                    <button data-screen="maintenance" class="menu-item w-full text-right p-3 rounded-lg hover:bg-gray-100 transition duration-150 text-gray-700">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
                    <button data-screen="laboratory" class="menu-item w-full text-right p-3 rounded-lg hover:bg-gray-100 transition duration-150 text-gray-700">Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©</button>
                    <button id="settingsLink" data-screen="settings" class="menu-item w-full text-right p-3 rounded-lg hover:bg-gray-100 transition duration-150 text-gray-700 hidden font-bold text-blue-700">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…)</button>
                </nav>
            </aside>

            <main id="screen-container" class="relative">
                <button id="backButton" class="absolute top-4 left-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center z-10 hidden">
                    Ø±Ø¬ÙˆØ¹
                </button>
                
                <div id="dashboard-screen" class="app-screen"></div>
                <div id="cleaning-screen" class="app-screen hidden"></div>
                <div id="temperature-screen" class="app-screen hidden"></div>
                <div id="maintenance-screen" class="app-screen hidden"></div>
                <div id="laboratory-screen" class="app-screen hidden"></div>
                <div id="settings-screen" class="app-screen hidden"></div>

                <div id="app-message" class="fixed top-20 right-4 p-4 rounded-lg shadow-xl text-white font-semibold z-50 hidden transition-opacity duration-300 opacity-0"></div>

            </main>
        </div>

        <footer id="app-footer">
            <p>&copy;  2025 Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ù…Ø³Ø§Ù„Ø®. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </footer>

    </div>

    <script>
        // ğŸ”¥ ØªÙƒÙˆÙŠÙ† Firebase - Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ø´Ø±ÙˆØ¹Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyCVK8Qrzl98ruBF8Fjh7WLpSFLi8_x464c",
            authDomain: "report-cf865.firebaseapp.com",
            projectId: "report-cf865",
            storageBucket: "report-cf865.firebasestorage.app",
            messagingSenderId: "195144802320",
            appId: "1:195144802320:web:ea87e2c00afbc2230aea95"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const STATE_KEY = 'slaughterhouse_app_state_final';
        const DEFAULT_BASE64_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgNDAwIDIwMCI+PHJlY3Qgd2lkdGg9IjQwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNDMDc5MzQiLz48dGV4dCB4PSIyMDAiIHk9IjEwMCIgZm9udC1mYW1pbHk9ImNhaXJvLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiBmaWxsPSIjZmZmZmZmIj5QYWxhY2UgZm9yIFNwbGFzaCBJbWFnZTwvdGV4dD48L3N2Zz4=';
        const DEFAULT_BASE64_ICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIyNSIgZmlsbD0iI0EwNTIyRCIvPjx0ZXh0IHg9IjI1IiB5PSIyNSIgZm9udC1mYW1pbHk9ImNhaXJvLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiBmaWxsPSIjZmZmZmZmIj5BPC90ZXh0Pjwvc3ZnPg==';

        const DEFAULT_STATE = {
            isLoggedIn: false,
            currentAbattoir: null,
            isAdmin: false,
            currentScreen: 'dashboard',
            config: { 
                splashImageUrl: DEFAULT_BASE64_IMAGE,
                unifiedImageUrl: DEFAULT_BASE64_ICON,
                abattoirs: [
                    { id: '12345', name: 'Ù…Ø³Ù„Ø® A' }
                ],
                adminCode: '70062',
                tempPoints: [
                    'KS1', 'KS2', 'KS3', 'KS4', 
                    'KS5',   'Chiller', 
                    'H.room', 'Hall'
                ],
                cleaningPoints: [
                    'ØµØ§Ù„Ø© Ø§Ù„Ø°Ø¨Ø­ ÙˆØ§Ù„Ø£Ø±Ø¶ÙŠØ§Øª', 'Ø·Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ ÙˆØ§Ù„Ø³ÙƒØ§ÙƒÙŠÙ†', 
                    'ØºØ±ÙØ© Ø§Ù„ÙƒØ±Ø´', 'Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª'
                ],
                maintenancePoints: [
                    'ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ (Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ø·Ù„)', 'Ø¹Ø·Ù„ Ø³Ø§Ø¨Ù‚ (Ù…Ù‚Ø§ÙˆÙ„)', 'ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© (Ù…ØªØ§Ø¨Ø¹Ø©)', 'Ø¹Ø·Ù„ Ø³Ø§Ø¨Ù‚ (Ø¨Ù„Ø¯ÙŠØ©)'
                ],
                labAnimalTypes: ['Ø¶Ø§Ù†', 'Ù…Ø§Ø¹Ø²', 'Ø¨Ù‚Ø±', 'Ø¬Ù…Ø§Ù„'],
                labAnimalGenders: ['Ø°ÙƒØ±', 'Ø§Ù†Ø«Ù‰'],
                labSuspicions: ['Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§', 'ÙŠØ±Ù‚Ø§Ù†', 'Ø±Ø§Ø¦Ø­Ø©', 'Ù…Ø¶Ø§Ø¯Ø§Øª Ø­ÙŠÙˆÙŠØ©'],
                labTests: ['Ø¨Ø±ÙˆØ³ÙŠÙ„Ø§', 'ÙŠØ±Ù‚Ø§Ù†', 'Ø±Ø§Ø¦Ø­Ø©', 'Ù…Ø¶Ø§Ø¯Ø§Øª Ø­ÙŠÙˆÙŠØ©'],
                labResults: ['Ø³Ù„Ø¨ÙŠØ©', 'Ø§ÙŠØ¬Ø§Ø¨ÙŠØ©', 'Ù…Ø´ÙƒÙˆÙƒ ÙÙŠÙ‡Ø§'],
                labJudgments: ['Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø°Ø¨Ø­', 'Ø§Ù„Ø±ÙØ¶', 'Ø§Ù„Ø­Ø¬Ø² Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø©', 'Ø§Ù„Ø§Ø¹Ø¯Ø§Ù…']
            },
            reports: {
                cleaning_reports: {},
                temperature_reports: {},
                maintenance_reports: {},
                laboratory_reports: {}
            }
        };

        let state = {};

        // ğŸ”¥ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
        async function loadFromFirebase() {
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                const configDoc = await db.collection('appConfig').doc('settings').get();
                if (configDoc.exists) {
                    state.config = { ...DEFAULT_STATE.config, ...configDoc.data() };
                }

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                const reportsSnapshot = await db.collection('reports').get();
                reportsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const reportType = data.reportType;
                    const key = data.key || doc.id;
                    if (state.reports[reportType]) {
                        state.reports[reportType][key] = data;
                    }
                });

                showMessage("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­", "success");
            } catch (error) {
                console.error("Error loading from Firebase:", error);
                // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† FirebaseØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                loadFromStorage();
            }
        }

        // ğŸ”¥ Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase
        async function saveToFirebase() {
            try {
                // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                await db.collection('appConfig').doc('settings').set(state.config, { merge: true });

                // Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                for (const reportType in state.reports) {
                    for (const key in state.reports[reportType]) {
                        const reportData = {
                            ...state.reports[reportType][key],
                            reportType: reportType,
                            key: key,
                            lastUpdated: new Date().toISOString()
                        };
                        await db.collection('reports').doc(key).set(reportData, { merge: true });
                    }
                }
            } catch (error) {
                console.error("Error saving to Firebase:", error);
                showMessage("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", "error");
            }
        }

        function loadFromStorage() {
            try {
                const storedState = localStorage.getItem(STATE_KEY);
                if (storedState) {
                    const parsed = JSON.parse(storedState);
                    state = {
                        ...DEFAULT_STATE,
                        ...parsed,
                        config: { ...DEFAULT_STATE.config, ...parsed.config },
                        reports: { ...DEFAULT_STATE.reports, ...parsed.reports }
                    };
                } else {
                    state = DEFAULT_STATE;
                }
            } catch (e) {
                console.error("Error loading state from localStorage:", e);
                state = DEFAULT_STATE;
            }
        }

        async function saveToStorage() {
            try {
                localStorage.setItem(STATE_KEY, JSON.stringify(state));
                // Ø­ÙØ¸ Ø¥Ù„Ù‰ Firebase Ø£ÙŠØ¶Ù‹Ø§
                if (state.isLoggedIn) {
                    await saveToFirebase();
                }
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
                showMessage("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§. Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù…ØªÙ„Ø¦Ø© Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­Ø©.", 'error');
            }
        }

        const dom = {
            splashScreen: document.getElementById('splash-screen'),
            loginScreen: document.getElementById('login-screen'),
            mainLayout: document.getElementById('main-layout'),
            abattoirCodeInput: document.getElementById('abattoirCode'),
            loginButton: document.getElementById('loginButton'),
            loginLoading: document.getElementById('loginLoading'),
            loginMessage: document.getElementById('loginMessage'),
            logoutButton: document.getElementById('logoutButton'),
            settingsLink: document.getElementById('settingsLink'),
            sidebarImageDisplay: document.getElementById('sidebar-image-display'),
            splashImageDisplay: document.getElementById('splash-image-display'),
            headerAbattoirName: document.getElementById('headerAbattoirName'),
            headerAbattoirCode: document.getElementById('headerAbattoirCode'),
            backButton: document.getElementById('backButton'),
            screenContainer: document.getElementById('screen-container'),
            appMessage: document.getElementById('app-message'),
        };

        function showMessage(msg, type = 'success') {
            dom.appMessage.textContent = msg;
            dom.appMessage.classList.remove('hidden', 'opacity-0', 'bg-red-500', 'bg-green-500');
            dom.appMessage.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            setTimeout(() => {
                dom.appMessage.classList.add('opacity-100');
            }, 50);
            setTimeout(() => {
                dom.appMessage.classList.remove('opacity-100');
                dom.appMessage.classList.add('opacity-0');
                setTimeout(() => dom.appMessage.classList.add('hidden'), 300);
            }, 3000);
        }

        const renderScreen = (screenName) => {
            state.currentScreen = screenName;
            document.querySelectorAll('.app-screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            const activeScreen = document.getElementById(`${screenName}-screen`);
            if (activeScreen) {
                activeScreen.classList.remove('hidden');
                switch(screenName) {
                    case 'dashboard': renderDashboard(); break;
                    case 'cleaning': renderCleaningScreen(); break;
                    case 'temperature': renderTemperatureScreen(); break;
                    case 'maintenance': renderMaintenanceScreen(); break;
                    case 'laboratory': renderLaboratoryScreen(); break;
                    case 'settings': renderSettingsScreen(); break;
                }
            }
            dom.backButton.classList.toggle('hidden', screenName === 'dashboard');
        };

        function updateHeaderAbattoirInfo() {
            if (state.currentAbattoir) {
                dom.headerAbattoirName.textContent = state.currentAbattoir.name;
                dom.headerAbattoirCode.textContent = state.currentAbattoir.id;
            } else {
                dom.headerAbattoirName.textContent = 'Ù…Ø³Ù„Ø®';
                dom.headerAbattoirCode.textContent = 'N/A';
            }
        }

        // ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase
        async function handleLogin(abattoirCode) {
            dom.loginButton.disabled = true;
            dom.loginLoading.classList.remove('hidden');
            dom.loginMessage.classList.add('hidden');

            try {
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Firestore Ø¹Ù† Ø§Ù„Ø±Ù…Ø²
                const doc = await db.collection('accessCodes').doc(abattoirCode).get();
                
                if (doc.exists) {
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„ ÙÙŠ Firebase
                    await auth.signInAnonymously();
                    
                    if (abattoirCode === '70062') {
                        state.isLoggedIn = true;
                        state.isAdmin = true;
                        state.currentAbattoir = null;
                        
                        dom.loginScreen.classList.add('hidden');
                        dom.mainLayout.classList.remove('hidden');
                        dom.settingsLink.classList.remove('hidden');
                        dom.sidebarImageDisplay.src = state.config.unifiedImageUrl;
                        updateHeaderAbattoirInfo();
                        
                        renderScreen('dashboard');
                        showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ÙƒÙ…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù….', 'success');
                    } else {
                        state.isLoggedIn = true;
                        state.isAdmin = false;
                        state.currentAbattoir = { id: abattoirCode, name: `Ù…Ø³Ù„Ø® ${abattoirCode}` };

                        dom.loginScreen.classList.add('hidden');
                        dom.mainLayout.classList.remove('hidden');
                        dom.settingsLink.classList.add('hidden');
                        dom.sidebarImageDisplay.src = state.config.unifiedImageUrl;
                        updateHeaderAbattoirInfo();
                        
                        renderScreen('dashboard');
                        showMessage(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³Ù„Ø® ${abattoirCode} Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
                    }
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    await loadFromFirebase();
                } else {
                    dom.loginMessage.textContent = 'Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ù„Ø® ØºÙŠØ± ØµØ­ÙŠØ­.';
                    dom.loginMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Login error:", error);
                dom.loginMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                dom.loginMessage.classList.remove('hidden');
            }

            dom.loginButton.disabled = false;
            dom.loginLoading.classList.add('hidden');
            saveToStorage();
        }

        function handleLogout() {
            state.isLoggedIn = false;
            state.currentAbattoir = null;
            state.isAdmin = false;
            dom.mainLayout.classList.add('hidden');
            dom.loginScreen.classList.remove('hidden');
            dom.abattoirCodeInput.value = '';
            renderScreen('login');
            saveToStorage();
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        async function handleImageUpload(event, configKey, imageElement) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ØµØ§Ù„Ø­.', 'error');
                return;
            }

            try {
                const base64Image = await fileToBase64(file);
                state.config[configKey] = base64Image;
                imageElement.src = base64Image;
                saveToStorage();
                renderSettingsScreen();
                showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙˆØ­ÙØ¸Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            } catch (e) {
                console.error("Error converting file:", e);
                showMessage('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø£Ùˆ Ø­ÙØ¸ Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø©.', 'error');
            }
        }

        async function setupAppAndLoad() {
            loadFromStorage();
            dom.splashImageDisplay.src = state.config.splashImageUrl;
            dom.sidebarImageDisplay.src = state.config.unifiedImageUrl;
            
            dom.splashScreen.classList.add('opacity-0');
            setTimeout(() => {
                dom.splashScreen.classList.add('hidden');
                if (state.isLoggedIn) {
                    if (state.isAdmin) {
                        dom.mainLayout.classList.remove('hidden');
                        dom.settingsLink.classList.remove('hidden');
                        updateHeaderAbattoirInfo();
                        renderScreen(state.currentScreen || 'dashboard');
                    } else if (state.currentAbattoir) {
                        dom.mainLayout.classList.remove('hidden');
                        dom.settingsLink.classList.add('hidden');
                        updateHeaderAbattoirInfo();
                        renderScreen(state.currentScreen || 'dashboard');
                    } else {
                        handleLogout(); 
                    }
                } else {
                    renderScreen('login'); 
                }
            }, 500);
        }

        function getCleaningColorClass(score) {
            const scoreValue = parseFloat(score);
            if (scoreValue === 0.5) return 'color-0-5';
            if (scoreValue === 1) return 'color-1';
            if (scoreValue === 1.5) return 'color-1-5';
            if (scoreValue === 2) return 'color-2';
            if (scoreValue === 2.5) return 'color-2-5';
            return 'color-na';
        }
        
        function getCleaningLabel(score) {
            const scoreValue = parseFloat(score);
            if (scoreValue === 2.5) return 'Ù…Ù…ØªØ§Ø²';
            if (scoreValue === 2) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
            if (scoreValue === 1.5) return 'Ø¬ÙŠØ¯';
            if (scoreValue === 1) return 'ÙˆØ³Ø·';
            if (scoreValue === 0.5) return 'Ø¶Ø¹ÙŠÙ';
            return '--';
        }
        
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        function exportPdf(title, elementId, reportType) {
            const printContainer = document.createElement('div');
            printContainer.id = 'print-container';
            printContainer.style.display = 'none';

            const currentDate = new Date();
            const monthNames = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ",
                              "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
            
            let headerHtml = '';
            
            switch(reportType) {
                case 'cleaning':
                    headerHtml = `
                        <div class="print-header" style="font-family: 'Cairo', sans-serif; font-size: 13px; font-weight: bold;">
                            <div class="cleaning-report-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø¸Ø§ÙØ©</div>
                            <div style="clear: both; overflow: hidden; margin-top: 10px;">
                                <div class="cleaning-report-abattoir">Ù…Ø³Ù„Ø®: ${state.currentAbattoir?.name || state.config.abattoirs[0]?.name || 'N/A'}</div>
                                <div class="cleaning-report-date">${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'temperature':
                    headerHtml = `
                        <div class="print-header" style="font-family: 'Cairo', sans-serif; font-size: 13px; font-weight: bold;">
                            <div class="temperature-report-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø±Ø§Ø±Ø©</div>
                            <div style="clear: both; overflow: hidden; margin-top: 10px;">
                                <div class="temperature-report-abattoir">Ù…Ø³Ù„Ø®: ${state.currentAbattoir?.name || state.config.abattoirs[0]?.name || 'N/A'}</div>
                                <div class="temperature-report-date">${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'laboratory':
                    headerHtml = `
                        <div class="print-header" style="font-family: 'Cairo', sans-serif; font-size: 13px; font-weight: bold;">
                            <div class="lab-report-title">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©</div>
                            <div style="clear: both; overflow: hidden; margin-top: 10px;">
                                <div class="lab-report-abattoir">Ù…Ø³Ù„Ø®: ${state.currentAbattoir?.name || state.config.abattoirs[0]?.name || 'N/A'}</div>
                                <div class="lab-report-date">${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}</div>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    headerHtml = `
                        <div class="print-header">
                            <h1>${title}</h1>
                            <h2>Ù…Ø³Ù„Ø®: ${state.currentAbattoir?.name || state.config.abattoirs[0]?.name || 'N/A'}</h2>
                            <h3>${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}</h3>
                        </div>
                    `;
            }

            let contentHtml = '';
            
            switch(reportType) {
                case 'cleaning':
                    contentHtml = generateCleaningReportForPrint();
                    break;
                case 'temperature':
                    contentHtml = generateTemperatureReportForPrint();
                    break;
                case 'maintenance':
                    contentHtml = generateMaintenanceReportForPrint();
                    break;
                case 'laboratory':
                    contentHtml = generateLaboratoryReportForPrint();
                    break;
            }

            printContainer.innerHTML = headerHtml + contentHtml;

            document.body.appendChild(printContainer);
            printContainer.style.display = 'block';

            window.print();

            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 500);
        }

        function generateCleaningReportForPrint() {
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const lastDay = getDaysInMonth(currentYear, currentMonth);
            const cleaningPoints = state.config.cleaningPoints;

            if (cleaningPoints.length === 0) {
                return '<p class="text-center text-gray-500 p-6">Ù„Ù… ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ù†Ù‚Ø§Ø· ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø¨Ø¹Ø¯.</p>';
            }

            let tableHeader = `
                <table class="min-w-full border-collapse border border-gray-400 text-right text-xs">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            ${cleaningPoints.map(point => 
                                `<th class="p-2 border border-gray-400 bg-gray-300 text-sm font-semibold table-cell-header">${point}</th>`
                            ).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            let tableRows = '';
            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const displayDate = String(day).padStart(2, '0');
                const docId = `${dateStr}_${abattoirId}`;
                const report = state.reports.cleaning_reports[docId];
                
                tableRows += `
                    <tr>
                        <td class="p-1 border border-gray-400 font-bold bg-gray-50 text-center">${displayDate}</td>
                        ${cleaningPoints.map(point => {
                            const value = report?.points?.[point] || '--';
                            return `
                                <td class="p-1 border border-gray-400 ${getCleaningColorClass(value)} text-center font-bold">
                                    ${value}
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }

            const legendHtml = `
                <div class="cleaning-legend-print">
                    <div class="legend-item-print">
                        <div class="legend-color-print color-0-5"></div>
                        <span>0.5 Ø¶Ø¹ÙŠÙ</span>
                    </div>
                    <div class="legend-item-print">
                        <div class="legend-color-print color-1"></div>
                        <span>1 ÙˆØ³Ø·</span>
                    </div>
                    <div class="legend-item-print">
                        <div class="legend-color-print color-1-5"></div>
                        <span>1.5 Ø¬ÙŠØ¯</span>
                    </div>
                    <div class="legend-item-print">
                        <div class="legend-color-print color-2"></div>
                        <span>2 Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</span>
                    </div>
                    <div class="legend-item-print">
                        <div class="legend-color-print color-2-5"></div>
                        <span>2.5 Ù…Ù…ØªØ§Ø²</span>
                    </div>
                </div>
            `;

            return tableHeader + tableRows + '</tbody></table>' + legendHtml;
        }

        function generateTemperatureReportForPrint() {
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const lastDay = getDaysInMonth(currentYear, currentMonth);
            const tempPoints = state.config.tempPoints;
            const periods = [
                { id: '7am', label: '7 ØµØ¨Ø§Ø­Ø§Ù‹' },
                { id: '11am', label: '11 ØµØ¨Ø§Ø­Ø§Ù‹' },
                { id: '2pm', label: '2 Ø¸Ù‡Ø±Ø§Ù‹' },
                { id: '5pm', label: '5 Ù…Ø³Ø§Ø¡Ù‹' }
            ];

            if (tempPoints.length === 0) {
                return '<p class="text-center text-gray-500 p-6">Ù„Ù… ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ù†Ù‚Ø§Ø· Ù‚ÙŠØ§Ø³ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø¨Ø¹Ø¯.</p>';
            }

            let tableHeader = `
                <table class="min-w-full border-collapse border border-gray-400 text-right text-xs">
                    <thead class="bg-gray-100">
                        <tr>
                            <th rowspan="2" class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            ${periods.map(p => `<th colspan="${tempPoints.length}" class="p-2 border border-gray-400 bg-gray-300 text-sm font-semibold temperature-period-header">${p.label}</th>`).join('')}
                        </tr>
                        <tr>
                            ${periods.map(p => tempPoints.map(point => 
                                `<th class="p-1 border border-gray-400 rotate-header">${point}</th>`
                            ).join('')).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            let tableRows = '';
            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const displayDate = String(day).padStart(2, '0');
                
                tableRows += `
                    <tr>
                        <td class="p-1 border border-gray-400 font-bold bg-gray-50 text-center">${displayDate}</td>
                        ${periods.map(p => tempPoints.map(point => {
                            const docId = `${dateStr}_${p.id}_${point}_${abattoirId}`;
                            const data = state.reports.temperature_reports[docId];
                            const value = data?.value || '--';
                            return `
                                <td class="p-1 border border-gray-400 text-center font-bold">
                                    ${value}
                                </td>
                            `;
                        }).join('')).join('')}
                    </tr>
                `;
            }

            return tableHeader + tableRows + '</tbody></table>';
        }

        function generateMaintenanceReportForPrint() {
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const lastDay = getDaysInMonth(currentYear, currentMonth);
            const maintenancePoints = state.config.maintenancePoints;

            if (maintenancePoints.length === 0) {
                return '<p class="text-center text-gray-500 p-6">Ù„Ù… ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ù†Ù‚Ø§Ø· Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ø¹Ø¯.</p>';
            }

            let tableHeader = `
                <table class="min-w-full border-collapse border border-gray-400 text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            ${maintenancePoints.map(point => 
                                `<th class="p-2 border border-gray-400 bg-gray-300 text-sm font-semibold maintenance-point-header">${point}</th>`
                            ).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            let tableRows = '';
            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const displayDate = String(day).padStart(2, '0');
                
                tableRows += `
                    <tr>
                        <td class="p-1 border border-gray-400 font-bold bg-gray-50 text-center">${displayDate}</td>
                        ${maintenancePoints.map(point => {
                            const docId = `${dateStr}_${point}_${abattoirId}`;
                            const data = state.reports.maintenance_reports[docId];
                            const value = data?.value || '--';
                            return `
                                <td class="p-1 border border-gray-400 text-center font-bold flexible-cell">
                                    ${value}
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }

            return tableHeader + tableRows + '</tbody></table>';
        }

        function generateLaboratoryReportForPrint() {
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const today = new Date().toISOString().substring(0, 10);
            const startDate = document.getElementById('lab-date-start')?.value || today;
            const endDate = document.getElementById('lab-date-end')?.value || today;

            const abattoirReports = Object.values(state.reports.laboratory_reports).filter(r => {
                const reportDate = r.date;
                return reportDate >= startDate && reportDate <= endDate && r.abattoirId === abattoirId;
            });
            
            abattoirReports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            let tableHtml = `
                <table class="min-w-full border-collapse border border-gray-400 text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border border-gray-400 w-16">Ù…</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ø¬Ù†Ø³ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„Ø§Ø´ØªØ¨Ø§Ù‡</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„Ø­ÙƒÙ…</th>
                            <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (abattoirReports.length === 0) {
                tableHtml += `
                    <tr>
                        <td colspan="10" class="p-4 border border-gray-400 text-center text-gray-500">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ­ÙˆØµØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®
                        </td>
                    </tr>
                `;
            } else {
                abattoirReports.forEach((report, index) => {
                    tableHtml += `
                        <tr>
                            <td class="p-1 border border-gray-400 w-16 text-center">${index + 1}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.data.owner || 'N/A'}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.data.phone || 'N/A'}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.data.animalType || 'N/A'}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.data.animalGender || 'N/A'}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.data.suspicion || 'N/A'}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.data.test || 'N/A'}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.data.result || 'N/A'}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.data.judgment || 'N/A'}</td>
                            <td class="p-1 border border-gray-400 flexible-cell">${report.date || 'N/A'}</td>
                        </tr>
                    `;
                });
            }

            tableHtml += '</tbody></table>';

            // Generate statistics tables
            const statsTables = generateLabStatisticsTables(abattoirReports);

            return tableHtml + statsTables;
        }

        function generateLabStatisticsTables(reports) {
            const totalSamples = reports.length;
            
            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†
            const animalTypeStats = {};
            state.config.labAnimalTypes.forEach(type => {
                animalTypeStats[type] = reports.filter(r => r.data.animalType === type).length;
            });
            
            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            const testStats = {};
            state.config.labTests.forEach(test => {
                testStats[test] = reports.filter(r => r.data.test === test).length;
            });
            
            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªÙŠØ¬Ø©
            const resultStats = {};
            state.config.labResults.forEach(result => {
                resultStats[result] = reports.filter(r => r.data.result === result).length;
            });

            let animalTypeTable = `
                <div style="flex: 1;">
                    <div class="stats-table-title">Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</div>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(animalTypeStats).forEach(([type, count]) => {
                animalTypeTable += `
                    <tr>
                        <td>${type}</td>
                        <td>${count}</td>
                    </tr>
                `;
            });
            
            animalTypeTable += `
                        </tbody>
                    </table>
                </div>
            `;

            let testTable = `
                <div style="flex: 1;">
                    <div class="stats-table-title">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(testStats).forEach(([test, count]) => {
                testTable += `
                    <tr>
                        <td>${test}</td>
                        <td>${count}</td>
                    </tr>
                `;
            });
            
            testTable += `
                        </tbody>
                    </table>
                </div>
            `;

            let resultTable = `
                <div style="flex: 1;">
                    <div class="stats-table-title">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(resultStats).forEach(([result, count]) => {
                resultTable += `
                    <tr>
                        <td>${result}</td>
                        <td>${count}</td>
                    </tr>
                `;
            });
            
            resultTable += `
                        </tbody>
                    </table>
                </div>
            `;

            return `
                <div class="stats-tables-container">
                    ${animalTypeTable}
                    ${testTable}
                    ${resultTable}
                </div>
            `;
        }
        
        function renderDashboard() {
            const screen = document.getElementById('dashboard-screen');
            const abattoirName = state.isAdmin ? ' ' : (state.currentAbattoir?.name || 'Ù…Ø³Ù„Ø®');
            
            screen.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-emerald-600"> ${abattoirName}</h3>
                    <p class="text-gray-600 mb-4"></p>
                    ${state.isAdmin ? 
                        '<p class="text-blue-600 font-semibold"></p>' : 
                        '<p class="text-green-600"></p>'
                    }
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button class="app-button bg-purple-500 text-white" data-action="temperature">Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø©</button>
                    <button class="app-button bg-blue-500 text-white" data-action="cleaning">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¸Ø§ÙØ©</button>
                    <button class="app-button bg-yellow-500 text-white" data-action="maintenance">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
                    <button class="app-button bg-teal-500 text-white" data-action="laboratory">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØ¨Ø±</button>
                </div>
            `;

            screen.querySelectorAll('.app-button').forEach(button => {
                if (button.dataset.action) {
                    button.addEventListener('click', () => renderScreen(button.dataset.action));
                }
            });
        }

        function renderCleaningScreen() {
            if (!state.currentAbattoir && !state.isAdmin) {
                document.getElementById('cleaning-screen').innerHTML = '<p class="text-2xl text-red-600 font-bold text-center mt-20">Ø¹ÙÙˆØ§Ù‹ØŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³Ù„Ø® Ø£ÙˆÙ„Ø§Ù‹.</p>';
                return;
            }
            
            const screen = document.getElementById('cleaning-screen');
            const abattoir = state.currentAbattoir?.name || state.config.abattoirs[0]?.name || 'Ø§Ù„Ù…Ø³Ù„Ø® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const currentMonthYear = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;

            screen.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
                <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-md">
                    <span class="text-lg font-semibold text-gray-700">Ø§Ù„Ù…Ø³Ù„Ø®: ${abattoir}</span>
                    <input type="month" id="cleaning-month-filter" value="${currentMonthYear}" class="p-2 border rounded-lg text-lg">
                </div>
                <div class="flex justify-end items-center mb-4">
                    <button id="exportCleaningReport" class="app-button bg-sky-600 text-white">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
                </div>
                <div id="cleaning-report-content" class="overflow-x-auto bg-white rounded-xl shadow-lg horizontal-report">
                    <table class="min-w-full border-collapse border border-gray-400 text-right text-xs horizontal-table">
                    </table>
                </div>
                <div class="cleaning-legend">
                    <div class="legend-item">
                        <div class="legend-color color-0-5"></div>
                        <span>0.5 Ø¶Ø¹ÙŠÙ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-1"></div>
                        <span>1 ÙˆØ³Ø·</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-1-5"></div>
                        <span>1.5 Ø¬ÙŠØ¯</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-2"></div>
                        <span>2 Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-2-5"></div>
                        <span>2.5 Ù…Ù…ØªØ§Ø²</span>
                    </div>
                </div>
            `;
            
            const monthFilter = document.getElementById('cleaning-month-filter');
            monthFilter.addEventListener('change', (e) => {
                const [year, month] = e.target.value.split('-').map(Number);
                rebuildCleaningTable(year, month);
            });
            document.getElementById('cleaning-report-content').addEventListener('change', handleCleaningInput);
            document.getElementById('cleaning-report-content').addEventListener('click', handleCleaningApprove);
            document.getElementById('exportCleaningReport').addEventListener('click', () => exportPdf('ØªÙ‚Ø±ÙŠØ± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¸Ø§ÙØ©', 'cleaning-report-content', 'cleaning'));

            rebuildCleaningTable(currentYear, currentMonth);
        }

        function rebuildCleaningTable(year, month) {
            const lastDay = getDaysInMonth(year, month);
            const cleaningPoints = state.config.cleaningPoints;
            const scores = [2.5, 2, 1.5, 1, 0.5];
            const abattoirId = state.currentAbattoir?.id || 'admin';

            if (cleaningPoints.length === 0) {
                document.querySelector('#cleaning-report-content table').innerHTML = `
                    <p class="p-6 text-center text-gray-500">
                        Ù„Ù… ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ù†Ù‚Ø§Ø· ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø¨Ø¹Ø¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.
                    </p>
                `;
                return;
            }

            let tableHeader = `
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        ${cleaningPoints.map(point => 
                            `<th class="p-2 border border-gray-400 bg-gray-300 text-sm font-semibold table-cell-header">${point}</th>`
                        ).join('')}
                        <th class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ø¹ØªÙ…Ø§Ø¯/Ø­Ø°Ù</th>
                    </tr>
                </thead>
            `;

            let tableRows = '';
            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const displayDate = String(day).padStart(2, '0');
                
                tableRows += `
                    <tr data-date="${dateStr}" class="hover:bg-yellow-50">
                        <td class="p-1 border border-gray-400 font-bold bg-gray-50 text-center">${displayDate}</td>
                        ${cleaningPoints.map(point => `
                            <td class="p-0 border border-gray-400 w-24 h-10">
                                <select data-date="${dateStr}" data-point="${point}" class="cleaning-score-select-table text-sm">
                                    <option value="" class="bg-gray-100">--</option>
                                    ${scores.map(score => 
                                        `<option value="${score}" class="${getCleaningColorClass(score)}">${score}</option>`
                                    ).join('')}
                                </select>
                            </td>
                        `).join('')}
                        <td class="p-1 border border-gray-400 text-center">
                            <button data-date="${dateStr}" class="approve-day-button bg-green-500 text-white p-1 rounded text-xs disabled:opacity-50 mr-1">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
                            <button data-date="${dateStr}" class="delete-day-button bg-red-500 text-white p-1 rounded text-xs">Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `;
            }

            const tableContainer = document.querySelector('#cleaning-report-content table');
            if (tableContainer) {
                tableContainer.innerHTML = tableHeader + `<tbody id="cleaning-table-body">${tableRows}</tbody>`;
                updateCleaningDataInTable(year, month);
            }
        }
        
        function updateCleaningDataInTable(year, month) {
            const tableBody = document.getElementById('cleaning-table-body');
            if (!tableBody) return;

            const abattoirId = state.currentAbattoir?.id || 'admin';

            tableBody.querySelectorAll('select.cleaning-score-select-table').forEach(select => {
                const date = select.dataset.date;
                const point = select.dataset.point;
                const docId = `${date}_${abattoirId}`;
                
                const report = state.reports.cleaning_reports[docId];
                
                if (report && report.points && report.points[point]) {
                    const score = report.points[point];
                    select.value = score;
                    select.className = `cleaning-score-select-table text-sm ${getCleaningColorClass(score)}`;
                    if (report.approved) {
                        select.disabled = true;
                        select.classList.add('cursor-not-allowed', 'approved-cell');
                    } else {
                        select.disabled = false;
                        select.classList.remove('cursor-not-allowed', 'approved-cell');
                    }
                } else {
                    select.value = '';
                    select.disabled = false;
                    select.className = `cleaning-score-select-table text-sm ${getCleaningColorClass(null)}`;
                }
            });

            tableBody.querySelectorAll('.approve-day-button').forEach(button => {
                const date = button.dataset.date;
                const selectsForDay = tableBody.querySelectorAll(`select.cleaning-score-select-table[data-date="${date}"]`);
                const docId = `${date}_${abattoirId}`;
                const report = state.reports.cleaning_reports[docId];
                
                let allApproved = report?.approved || false;
                let allFilled = true;
                
                selectsForDay.forEach(select => {
                    if (!select.value) {
                        allFilled = false;
                    }
                });

                if (allApproved) {
                    button.textContent = 'Ù…Ø¹ØªÙ…Ø¯';
                    button.disabled = true;
                    button.classList.add('bg-green-700');
                    button.classList.remove('bg-green-500');
                } else {
                    button.textContent = 'Ø§Ø¹ØªÙ…Ø§Ø¯';
                    button.disabled = !allFilled;
                    button.classList.remove('bg-green-700');
                    button.classList.add('bg-green-500');
                }
            });
        }
        
        function handleCleaningInput(e) {
            if (!e.target.classList.contains('cleaning-score-select-table')) return;

            const select = e.target;
            const value = select.value;
            const date = select.dataset.date;
            const point = select.dataset.point;
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const docId = `${date}_${abattoirId}`;
            
            select.className = `cleaning-score-select-table text-sm ${getCleaningColorClass(value)}`;

            if (!state.reports.cleaning_reports[docId]) {
                 state.reports.cleaning_reports[docId] = {
                    date: date,
                    abattoirId: abattoirId,
                    points: {},
                    approved: false,
                    createdAt: new Date().toISOString()
                };
            }
            
            state.reports.cleaning_reports[docId].points[point] = parseFloat(value);
            
            saveToStorage();
            
            const [year, month] = date.split('-').map(Number);
            updateCleaningDataInTable(year, month);
        }

        function handleCleaningApprove(e) {
            if (e.target.classList.contains('approve-day-button')) {
                const dateToApprove = e.target.dataset.date;
                const abattoirId = state.currentAbattoir?.id || 'admin';
                const docId = `${dateToApprove}_${abattoirId}`;
                const tableBody = document.getElementById('cleaning-table-body');
                const selects = tableBody.querySelectorAll(`select.cleaning-score-select-table[data-date="${dateToApprove}"]`);

                if (selects.length === 0) return;

                for (const select of selects) {
                    if (!select.value) {
                        showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙ‚ÙŠÙŠÙ… Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ø¸Ø§ÙØ© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯.', 'error');
                        return;
                    }
                }

                if (state.reports.cleaning_reports[docId]) {
                    state.reports.cleaning_reports[docId].approved = true;
                } else {
                    state.reports.cleaning_reports[docId] = {
                        date: dateToApprove,
                        abattoirId: abattoirId,
                        points: {},
                        approved: true,
                        createdAt: new Date().toISOString()
                    };
                    selects.forEach(select => {
                        state.reports.cleaning_reports[docId].points[select.dataset.point] = parseFloat(select.value);
                    });
                }

                saveToStorage();
                
                const [year, month] = dateToApprove.split('-').map(Number);
                updateCleaningDataInTable(year, month);
                showMessage(`ØªÙ… Ø­ÙØ¸ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­ Ù„ÙŠÙˆÙ… ${dateToApprove}. ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ù‚ÙˆÙ„.`);
            }
            
            if (e.target.classList.contains('delete-day-button')) {
                const dateToDelete = e.target.dataset.date;
                const abattoirId = state.currentAbattoir?.id || 'admin';
                const docId = `${dateToDelete}_${abattoirId}`;
                
                if (state.reports.cleaning_reports[docId]) {
                    delete state.reports.cleaning_reports[docId];
                    saveToStorage();
                    
                    const [year, month] = dateToDelete.split('-').map(Number);
                    rebuildCleaningTable(year, month);
                    showMessage(`ØªÙ… Ø­Ø°Ù ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¸Ø§ÙØ© Ù„ÙŠÙˆÙ… ${dateToDelete}.`);
                }
            }
        }
        
        function renderTemperatureScreen() {
            if (!state.currentAbattoir && !state.isAdmin) {
                document.getElementById('temperature-screen').innerHTML = '<p class="text-2xl text-red-600 font-bold text-center mt-20">Ø¹ÙÙˆØ§Ù‹ØŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³Ù„Ø® Ø£ÙˆÙ„Ø§Ù‹.</p>';
                return;
            }
            
            const screen = document.getElementById('temperature-screen');
            const abattoir = state.currentAbattoir?.name || state.config.abattoirs[0]?.name || 'Ø§Ù„Ù…Ø³Ù„Ø® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const currentMonthYear = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;

            screen.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">ØªÙ‚Ø±ÙŠØ± Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©</h2>
                <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-md">
                    <span class="text-lg font-semibold text-gray-700">Ø§Ù„Ù…Ø³Ù„Ø®: ${abattoir}</span>
                    <input type="month" id="temp-month-filter" value="${currentMonthYear}" class="p-2 border rounded-lg text-lg">
                </div>
                <div class="flex justify-end items-center mb-4">
                    <button id="exportTempReport" class="app-button bg-sky-600 text-white">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
                </div>
                <div id="temp-report-content" class="overflow-x-auto bg-white rounded-xl shadow-lg horizontal-report">
                    <table class="min-w-full border-collapse border border-gray-400 text-right text-xs horizontal-table">
                    </table>
                </div>
            `;

            const monthFilter = document.getElementById('temp-month-filter');
            monthFilter.addEventListener('change', (e) => {
                const [year, month] = e.target.value.split('-').map(Number);
                rebuildTemperatureTable(year, month);
            });

            document.getElementById('exportTempReport').addEventListener('click', () => exportPdf('ØªÙ‚Ø±ÙŠØ± Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø©', 'temp-report-content', 'temperature'));
            
            rebuildTemperatureTable(currentYear, currentMonth);

            const tempReportContent = document.getElementById('temp-report-content');
            tempReportContent.addEventListener('input', handleTemperatureInput);
            tempReportContent.addEventListener('click', handleTemperatureApprove);
        }

        function rebuildTemperatureTable(year, month) {
            const lastDay = getDaysInMonth(year, month);
            const tempPoints = state.config.tempPoints;
            const periods = [
                { id: '7am', label: '7 ØµØ¨Ø§Ø­Ø§Ù‹' },
                { id: '11am', label: '11 ØµØ¨Ø§Ø­Ø§Ù‹' },
                { id: '2pm', label: '2 Ø¸Ù‡Ø±Ø§Ù‹' },
                { id: '5pm', label: '5 Ù…Ø³Ø§Ø¡Ù‹' }
            ];
            const abattoirId = state.currentAbattoir?.id || 'admin';

            if (tempPoints.length === 0) {
                document.querySelector('#temp-report-content table').innerHTML = `<tbody id="temperature-table-body"><tr class="p-6 text-center text-gray-500"><td colspan="100%">Ù„Ù… ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ù†Ù‚Ø§Ø· Ù‚ÙŠØ§Ø³ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø¨Ø¹Ø¯.</td></tr></tbody>`;
                return;
            }

            let tableHeader = `
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th rowspan="2" class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        ${periods.map(p => `<th colspan="${tempPoints.length}" class="p-2 border border-gray-400 bg-gray-300 text-sm font-semibold temperature-period-header">${p.label}</th>`).join('')}
                        <th rowspan="2" class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</th>
                    </tr>
                    <tr>
                        ${periods.map(p => tempPoints.map(point => 
                            `<th class="p-1 border border-gray-400 temperature-point-header">${point}</th>`
                        ).join('')).join('')}
                    </tr>
                </thead>
            `;

            let tableRows = '';
            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const displayDate = String(day).padStart(2, '0');
                
                tableRows += `
                    <tr data-date="${dateStr}" class="hover:bg-yellow-50">
                        <td class="p-1 border border-gray-400 font-bold bg-gray-50 text-center">${displayDate}</td>
                        ${periods.map(p => tempPoints.map(point => `
                            <td class="p-0 border border-gray-400 w-14 h-10">
                                <input type="number" data-date="${dateStr}" data-period="${p.id}" data-point="${point}" max="99" class="table-input temperature-input text-sm" placeholder="--">
                            </td>
                        `).join('') ).join('')}
                        <td class="p-1 border border-gray-400 text-center">
                            <button data-date="${dateStr}" class="approve-day-button bg-green-500 text-white p-1 rounded text-xs disabled:opacity-50">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
                        </td>
                    </tr>
                `;
            }

            const tableContainer = document.querySelector('#temp-report-content table');
            if (tableContainer) {
                tableContainer.innerHTML = tableHeader + `<tbody id="temperature-table-body">${tableRows}</tbody>`;
                updateTemperatureDataInTable(year, month);
            }
        }

        function updateTemperatureDataInTable(year, month) {
            const tableBody = document.getElementById('temperature-table-body');
            if (!tableBody) return;

            const abattoirId = state.currentAbattoir?.id || 'admin';

            tableBody.querySelectorAll('input.temperature-input').forEach(input => {
                const date = input.dataset.date;
                const period = input.dataset.period;
                const point = input.dataset.point;
                const docId = `${date}_${period}_${point}_${abattoirId}`;
                
                const data = state.reports.temperature_reports[docId];
                
                if (data) {
                    input.value = data.value;
                    if (data.approved) {
                        input.disabled = true;
                        input.classList.add('bg-gray-100', 'cursor-not-allowed');
                    } else {
                        input.disabled = false;
                        input.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    }
                } else {
                    input.value = '';
                    input.disabled = false;
                    input.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
            });

            tableBody.querySelectorAll('.approve-day-button').forEach(button => {
                const date = button.dataset.date;
                const inputsForDay = tableBody.querySelectorAll(`input.temperature-input[data-date="${date}"]`);
                let allApproved = true;
                let allFilled = true;
                
                inputsForDay.forEach(input => {
                    const period = input.dataset.period;
                    const point = input.dataset.point;
                    const docId = `${date}_${period}_${point}_${abattoirId}`;
                    const data = state.reports.temperature_reports[docId];
                    
                    if (!data || !data.approved) {
                        allApproved = false;
                    }
                    if (!input.value) {
                        allFilled = false;
                    }
                });

                if (allApproved) {
                    button.textContent = 'Ù…Ø¹ØªÙ…Ø¯';
                    button.disabled = true;
                    button.classList.add('bg-green-700');
                    button.classList.remove('bg-green-500');
                } else {
                    button.textContent = 'Ø§Ø¹ØªÙ…Ø§Ø¯';
                    button.disabled = !allFilled;
                    button.classList.remove('bg-green-700');
                    button.classList.add('bg-green-500');
                }
            });
        }

        function handleTemperatureInput(e) {
            if (!e.target.classList.contains('temperature-input')) return;

            const input = e.target;
            const value = parseFloat(input.value);
            const date = input.dataset.date;
            const period = input.dataset.period;
            const point = input.dataset.point;
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const docId = `${date}_${period}_${point}_${abattoirId}`;

            if (isNaN(value) || value === null) {
                if (state.reports.temperature_reports[docId]) {
                    delete state.reports.temperature_reports[docId].value;
                }
                saveToStorage();
                return;
            }

            if (value > 99) {
                input.value = 99;
                showMessage('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ù‡Ùˆ 99.', 'error');
            }

            state.reports.temperature_reports[docId] = {
                date: date,
                period: period,
                point: point,
                value: parseFloat(input.value),
                approved: state.reports.temperature_reports[docId]?.approved || false,
                abattoirId: abattoirId
            };

            saveToStorage();
            
            const [year, month] = date.split('-').map(Number);
            updateTemperatureDataInTable(year, month);
        }

        function handleTemperatureApprove(e) {
            if (!e.target.classList.contains('approve-day-button')) return;

            const dateToApprove = e.target.dataset.date;
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const tableBody = document.getElementById('temperature-table-body');
            const inputs = tableBody.querySelectorAll(`input.temperature-input[data-date="${dateToApprove}"]`);

            if (inputs.length === 0) {
                showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„ Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§.', 'error');
                return;
            }

            for (const input of inputs) {
                if (!input.value) {
                    showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯.', 'error');
                    return;
                }
            }

            for (const input of inputs) {
                const date = input.dataset.date;
                const period = input.dataset.period;
                const point = input.dataset.point;
                const docId = `${date}_${period}_${point}_${abattoirId}`;
                
                state.reports.temperature_reports[docId] = {
                    ...state.reports.temperature_reports[docId],
                    approved: true,
                    value: parseFloat(input.value)
                };
            }

            saveToStorage();
            
            const [year, month] = dateToApprove.split('-').map(Number);
            updateTemperatureDataInTable(year, month);
            showMessage(`ØªÙ… Ø­ÙØ¸ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­ Ù„ÙŠÙˆÙ… ${dateToApprove}. ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ù‚ÙˆÙ„.`);
        }

        function renderMaintenanceScreen() {
            if (!state.currentAbattoir && !state.isAdmin) {
                document.getElementById('maintenance-screen').innerHTML = '<p class="text-2xl text-red-600 font-bold text-center mt-20">Ø¹ÙÙˆØ§Ù‹ØŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³Ù„Ø® Ø£ÙˆÙ„Ø§Ù‹.</p>';
                return;
            }
            
            const screen = document.getElementById('maintenance-screen');
            const abattoir = state.currentAbattoir?.name || state.config.abattoirs[0]?.name || 'Ø§Ù„Ù…Ø³Ù„Ø® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const currentMonthYear = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;

            screen.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
                <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-md">
                    <span class="text-lg font-semibold text-gray-700">Ø§Ù„Ù…Ø³Ù„Ø®: ${abattoir}</span>
                    <input type="month" id="maint-month-filter" value="${currentMonthYear}" class="p-2 border rounded-lg text-lg">
                </div>
                <div class="flex justify-end items-center mb-4">
                    <button id="exportMaintenanceReport" class="app-button bg-sky-600 text-white">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
                </div>
                <div id="maintenance-report-content" class="overflow-x-auto bg-white rounded-xl shadow-lg horizontal-report">
                    <table class="min-w-full border-collapse border border-gray-400 text-sm horizontal-table">
                    </table>
                </div>
            `;
            
            const monthFilter = document.getElementById('maint-month-filter');
            monthFilter.addEventListener('change', (e) => {
                const [year, month] = e.target.value.split('-').map(Number);
                rebuildMaintenanceTable(year, month);
            });
            document.getElementById('maintenance-report-content').addEventListener('input', handleMaintenanceInput);
            document.getElementById('maintenance-report-content').addEventListener('click', handleMaintenanceApprove);
            document.getElementById('exportMaintenanceReport').addEventListener('click', () => exportPdf('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©', 'maintenance-report-content', 'maintenance'));

            rebuildMaintenanceTable(currentYear, currentMonth);
        }
        
        function rebuildMaintenanceTable(year, month) {
            const lastDay = getDaysInMonth(year, month);
            const maintenancePoints = state.config.maintenancePoints;
            const abattoirId = state.currentAbattoir?.id || 'admin';

            if (maintenancePoints.length === 0) {
                document.querySelector('#maintenance-report-content table').innerHTML = `<tbody id="maintenance-table-body"><tr class="p-6 text-center text-gray-500"><td colspan="100%">Ù„Ù… ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ù†Ù‚Ø§Ø· Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ø¹Ø¯.</td></tr></tbody>`;
                return;
            }

            let tableHeader = `
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        ${maintenancePoints.map(point => 
                            `<th class="p-2 border border-gray-400 bg-gray-300 text-sm font-semibold maintenance-point-header">${point}</th>`
                        ).join('')}
                        <th class="p-2 border border-gray-400 bg-gray-200 text-sm font-semibold w-24">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…</th>
                    </tr>
                </thead>
            `;

            let tableRows = '';
            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const displayDate = String(day).padStart(2, '0');
                
                tableRows += `
                    <tr data-date="${dateStr}" class="hover:bg-yellow-50">
                        <td class="p-1 border border-gray-400 font-bold bg-gray-50 text-center">${displayDate}</td>
                        ${maintenancePoints.map(point => `
                            <td class="p-0 border border-gray-400">
                                <textarea data-date="${dateStr}" data-point="${point}" class="flexible-input" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©..."></textarea>
                            </td>
                        `).join('')}
                        <td class="p-1 border border-gray-400 text-center">
                            <button data-date="${dateStr}" class="approve-day-button bg-green-500 text-white p-1 rounded text-xs disabled:opacity-50">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
                        </td>
                    </tr>
                `;
            }

            const tableContainer = document.querySelector('#maintenance-report-content table');
            if (tableContainer) {
                tableContainer.innerHTML = tableHeader + `<tbody id="maintenance-table-body">${tableRows}</tbody>`;
                updateMaintenanceDataInTable(year, month);
            }
        }
        
        function updateMaintenanceDataInTable(year, month) {
            const tableBody = document.getElementById('maintenance-table-body');
            if (!tableBody) return;

            const abattoirId = state.currentAbattoir?.id || 'admin';

            tableBody.querySelectorAll('textarea.flexible-input').forEach(textarea => {
                const date = textarea.dataset.date;
                const point = textarea.dataset.point;
                const docId = `${date}_${point}_${abattoirId}`;
                
                const data = state.reports.maintenance_reports[docId];
                
                if (data) {
                    textarea.value = data.value;
                    if (data.approved) {
                        textarea.disabled = true;
                        textarea.classList.add('bg-gray-100', 'cursor-not-allowed');
                    } else {
                        textarea.disabled = false;
                        textarea.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    }
                } else {
                    textarea.value = '';
                    textarea.disabled = false;
                    textarea.classList.remove('bg-gray-100', 'cursor-not-allowed');
                }
                
                autoResizeTextarea(textarea);
            });

            tableBody.querySelectorAll('.approve-day-button').forEach(button => {
                const date = button.dataset.date;
                const textareasForDay = tableBody.querySelectorAll(`textarea.flexible-input[data-date="${date}"]`);
                let allApproved = true;
                let allFilled = true;
                
                textareasForDay.forEach(textarea => {
                    const point = textarea.dataset.point;
                    const docId = `${date}_${point}_${abattoirId}`;
                    const data = state.reports.maintenance_reports[docId];
                    
                    if (!data || !data.approved) {
                        allApproved = false;
                    }
                    if (!textarea.value.trim()) {
                        allFilled = false;
                    }
                });

                if (allApproved) {
                    button.textContent = 'Ù…Ø¹ØªÙ…Ø¯';
                    button.disabled = true;
                    button.classList.add('bg-green-700');
                    button.classList.remove('bg-green-500');
                } else {
                    button.textContent = 'Ø§Ø¹ØªÙ…Ø§Ø¯';
                    button.disabled = !allFilled; 
                    button.classList.remove('bg-green-700');
                    button.classList.add('bg-green-500');
                }
            });
        }
        
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        
        function handleMaintenanceInput(e) {
            if (!e.target.classList.contains('flexible-input')) return;

            const textarea = e.target;
            const value = textarea.value.trim();
            const date = textarea.dataset.date;
            const point = textarea.dataset.point;
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const docId = `${date}_${point}_${abattoirId}`;

            autoResizeTextarea(textarea);

            if (!value) {
                if (state.reports.maintenance_reports[docId]) {
                    delete state.reports.maintenance_reports[docId].value;
                }
                saveToStorage();
                return;
            }

            state.reports.maintenance_reports[docId] = {
                date: date,
                point: point,
                value: value,
                approved: state.reports.maintenance_reports[docId]?.approved || false,
                abattoirId: abattoirId
            };

            saveToStorage();
            
            const [year, month] = date.split('-').map(Number);
            updateMaintenanceDataInTable(year, month);
        }

        function handleMaintenanceApprove(e) {
            if (!e.target.classList.contains('approve-day-button')) return;

            const dateToApprove = e.target.dataset.date;
            const abattoirId = state.currentAbattoir?.id || 'admin';
            const tableBody = document.getElementById('maintenance-table-body');
            const textareas = tableBody.querySelectorAll(`textarea.flexible-input[data-date="${dateToApprove}"]`);

            if (textareas.length === 0) return;

            for (const textarea of textareas) {
                if (!textarea.value.trim()) {
                    showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯.', 'error');
                    return;
                }
            }

            for (const textarea of textareas) {
                const date = textarea.dataset.date;
                const point = textarea.dataset.point;
                const docId = `${date}_${point}_${abattoirId}`;
                
                state.reports.maintenance_reports[docId] = {
                    ...state.reports.maintenance_reports[docId],
                    approved: true,
                    value: textarea.value
                };
            }

            saveToStorage();
            
            const [year, month] = dateToApprove.split('-').map(Number);
            updateMaintenanceDataInTable(year, month);
            showMessage(`ØªÙ… Ø­ÙØ¸ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù„ÙŠÙˆÙ… ${dateToApprove}. ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ù‚ÙˆÙ„.`);
        }

        function renderLaboratoryScreen() {
            if (!state.currentAbattoir && !state.isAdmin) {
                document.getElementById('laboratory-screen').innerHTML = '<p class="text-2xl text-red-600 font-bold text-center mt-20">Ø¹ÙÙˆØ§Ù‹ØŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø³Ù„Ø® Ø£ÙˆÙ„Ø§Ù‹.</p>';
                return;
            }
            
            const screen = document.getElementById('laboratory-screen');
            const abattoir = state.currentAbattoir?.name || state.config.abattoirs[0]?.name || 'Ø§Ù„Ù…Ø³Ù„Ø® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const today = new Date().toISOString().substring(0, 10);

            screen.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©</h2>
                <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-md">
                    <span class="text-lg font-semibold text-gray-700">Ø§Ù„Ù…Ø³Ù„Ø®: ${abattoir}</span>
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <label for="lab-date-start" class="text-lg font-semibold text-gray-700">Ù…Ù†:</label>
                        <input type="date" id="lab-date-start" value="${today}" class="lab-date-picker">
                        <label for="lab-date-end" class="text-lg font-semibold text-gray-700">Ø¥Ù„Ù‰:</label>
                        <input type="date" id="lab-date-end" value="${today}" class="lab-date-picker">
                    </div>
                </div>
                <div class="flex justify-end items-center mb-4">
                    <button id="exportLabReport" class="app-button bg-sky-600 text-white">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
                </div>
                <div id="laboratory-report-content" class="overflow-x-auto bg-white rounded-xl shadow-lg lab-table-container horizontal-report">
                    <table class="min-w-full border-collapse border border-gray-400 text-sm lab-table horizontal-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border border-gray-400 w-16">Ù…</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ø¬Ù†Ø³ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„Ø§Ø´ØªØ¨Ø§Ù‡</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„Ø­ÙƒÙ…</th>
                                <th class="p-2 border border-gray-400 table-cell-header">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="p-2 border border-gray-400 w-32 table-cell-header">Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯/Ø­Ø°Ù/ØªØ¹Ø¯ÙŠÙ„</th>
                            </tr>
                        </thead>
                        <tbody id="lab-table-body">
                            <tr id="new-lab-report-row" class="bg-yellow-50">
                                <td class="p-1 border border-gray-400 w-16 text-center font-bold">Ø¬Ø¯ÙŠØ¯</td>
                                <td class="p-0 border border-gray-400">
                                    <input type="text" data-field="owner" class="table-input new-lab-input text-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„">
                                </td>
                                <td class="p-0 border border-gray-400">
                                    <input type="text" data-field="phone" class="table-input new-lab-input text-sm" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙÙˆÙ†">
                                </td>
                                <td class="p-0 border border-gray-400">
                                    <select data-field="animalType" class="table-input new-lab-input text-sm">
                                        <option value="">-- Ø§Ø®ØªØ± --</option>
                                        ${state.config.labAnimalTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                    </select>
                                </td>
                                <td class="p-0 border border-gray-400">
                                    <select data-field="animalGender" class="table-input new-lab-input text-sm">
                                        <option value="">-- Ø§Ø®ØªØ± --</option>
                                        ${state.config.labAnimalGenders.map(gender => `<option value="${gender}">${gender}</option>`).join('')}
                                    </select>
                                </td>
                                <td class="p-0 border border-gray-400">
                                    <select data-field="suspicion" class="table-input new-lab-input text-sm">
                                        <option value="">-- Ø§Ø®ØªØ± --</option>
                                        ${state.config.labSuspicions.map(suspicion => `<option value="${suspicion}">${suspicion}</option>`).join('')}
                                    </select>
                                </td>
                                <td class="p-0 border border-gray-400">
                                    <select data-field="test" class="table-input new-lab-input text-sm">
                                        <option value="">-- Ø§Ø®ØªØ± --</option>
                                        ${state.config.labTests.map(test => `<option value="${test}">${test}</option>`).join('')}
                                    </select>
                                </td>
                                <td class="p-0 border border-gray-400">
                                    <select data-field="result" class="table-input new-lab-input text-sm">
                                        <option value="">-- Ø§Ø®ØªØ± --</option>
                                        ${state.config.labResults.map(result => `<option value="${result}">${result}</option>`).join('')}
                                    </select>
                                </td>
                                <td class="p-0 border border-gray-400">
                                    <select data-field="judgment" class="table-input new-lab-input text-sm">
                                        <option value="">-- Ø§Ø®ØªØ± --</option>
                                        ${state.config.labJudgments.map(judgment => `<option value="${judgment}">${judgment}</option>`).join('')}
                                    </select>
                                </td>
                                <td class="p-0 border border-gray-400">
                                    <input type="date" data-field="date" class="table-input new-lab-input text-sm" value="${today}">
                                </td>
                                <td class="p-1 border border-gray-400 text-center">
                                    <button id="addLabReport" class="bg-emerald-500 text-white p-1 rounded text-sm hover:bg-emerald-700">Ø¥Ø¶Ø§ÙØ©</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="lab-statistics" class="mt-2 p-2 bg-gray-50 rounded">
                        <div id="lab-stats-content"></div>
                    </div>
                </div>
            `;

            document.getElementById('exportLabReport').addEventListener('click', () => exportPdf('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©', 'laboratory-report-content', 'laboratory'));
            document.getElementById('addLabReport').addEventListener('click', saveLabReport);
            document.getElementById('lab-date-start').addEventListener('change', updateLabReportsTable);
            document.getElementById('lab-date-end').addEventListener('change', updateLabReportsTable);
            
            updateLabReportsTable();
        }

        function updateLabReportsTable() {
            const tableBody = document.getElementById('lab-table-body');
            const startDate = document.getElementById('lab-date-start').value;
            const endDate = document.getElementById('lab-date-end').value;
            const abattoirId = state.currentAbattoir?.id || 'admin';
            
            if (!tableBody) return;

            const abattoirReports = Object.values(state.reports.laboratory_reports).filter(r => {
                const reportDate = r.date;
                return reportDate >= startDate && reportDate <= endDate && r.abattoirId === abattoirId;
            });
            
            abattoirReports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            tableBody.querySelectorAll('tr:not(#new-lab-report-row)').forEach(row => row.remove());
            
            let rowIndex = 0;
            abattoirReports.forEach((report) => {
                rowIndex++;
                const newRow = document.createElement('tr');
                newRow.className = 'hover:bg-gray-50';
                newRow.dataset.id = report.id;
                
                newRow.innerHTML = `
                    <td class="p-1 border border-gray-400 w-16 text-center">${rowIndex}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.data.owner || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.data.phone || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.data.animalType || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.data.animalGender || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.data.suspicion || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.data.test || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.data.result || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.data.judgment || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 flexible-cell">${report.date || 'N/A'}</td>
                    <td class="p-1 border border-gray-400 text-center">
                        ${report.approved ? 
                            '<span class="bg-green-200 text-green-800 p-1 rounded text-xs">Ù…Ø¹ØªÙ…Ø¯</span>' : 
                            `<button class="approve-lab-button bg-green-500 text-white p-1 rounded text-xs mr-1" data-id="${report.id}">Ø§Ø¹ØªÙ…Ø§Ø¯</button>`
                        }
                        <button class="delete-lab-button bg-red-500 text-white p-1 rounded text-xs mr-1" data-id="${report.id}">Ø­Ø°Ù</button>
                        <button class="edit-lab-button bg-blue-500 text-white p-1 rounded text-xs" data-id="${report.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                    </td>
                `;
                tableBody.appendChild(newRow);
            });
            
            if (rowIndex === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="11" class="p-4 border border-gray-400 text-center text-gray-500">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ­ÙˆØµØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®
                    </td>
                `;
                tableBody.appendChild(noDataRow);
            }
            
            updateLabStatistics(abattoirReports);
            
            tableBody.addEventListener('click', handleLabActions);
        }

        function updateLabStatistics(reports) {
            const statsContainer = document.getElementById('lab-stats-content');
            if (!statsContainer) return;

            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†
            const animalTypeStats = {};
            state.config.labAnimalTypes.forEach(type => {
                animalTypeStats[type] = reports.filter(r => r.data.animalType === type).length;
            });
            
            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            const testStats = {};
            state.config.labTests.forEach(test => {
                testStats[test] = reports.filter(r => r.data.test === test).length;
            });
            
            // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØªÙŠØ¬Ø©
            const resultStats = {};
            state.config.labResults.forEach(result => {
                resultStats[result] = reports.filter(r => r.data.result === result).length;
            });

            let animalTypeTable = `
                <div style="flex: 1;">
                    <div class="stats-table-title">Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</div>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(animalTypeStats).forEach(([type, count]) => {
                animalTypeTable += `
                    <tr>
                        <td>${type}</td>
                        <td>${count}</td>
                    </tr>
                `;
            });
            
            animalTypeTable += `
                        </tbody>
                    </table>
                </div>
            `;

            let testTable = `
                <div style="flex: 1;">
                    <div class="stats-table-title">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(testStats).forEach(([test, count]) => {
                testTable += `
                    <tr>
                        <td>${test}</td>
                        <td>${count}</td>
                    </tr>
                `;
            });
            
            testTable += `
                        </tbody>
                    </table>
                </div>
            `;

            let resultTable = `
                <div style="flex: 1;">
                    <div class="stats-table-title">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(resultStats).forEach(([result, count]) => {
                resultTable += `
                    <tr>
                        <td>${result}</td>
                        <td>${count}</td>
                    </tr>
                `;
            });
            
            resultTable += `
                        </tbody>
                    </table>
                </div>
            `;

            statsContainer.innerHTML = `
                <div class="stats-tables-container">
                    ${animalTypeTable}
                    ${testTable}
                    ${resultTable}
                </div>
            `;
        }

        function saveLabReport() {
            const newInputs = document.querySelectorAll('.new-lab-input');
            const reportData = {};
            let isComplete = true;

            newInputs.forEach(input => {
                const value = input.value.trim();
                const field = input.dataset.field;
                reportData[field] = value;
                if (!value && ['owner', 'phone', 'animalType', 'suspicion', 'test', 'result', 'judgment', 'date'].includes(field)) {
                    isComplete = false;
                }
            });

            if (!isComplete) {
                showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠ.", 'error');
                return;
            }

            const labReportId = Date.now().toString();
            const selectedDate = reportData.date;
            const abattoirId = state.currentAbattoir?.id || 'admin';
            
            state.reports.laboratory_reports[labReportId] = {
                id: labReportId,
                data: reportData,
                approved: false,
                date: selectedDate,
                createdAt: new Date().toISOString(),
                abattoirId: abattoirId
            };

            saveToStorage();
            updateLabReportsTable();

            newInputs.forEach(input => {
                if (input.type === 'date') {
                    input.value = new Date().toISOString().substring(0, 10);
                } else {
                    input.value = '';
                }
            });
            showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
        }

        function handleLabActions(e) {
            if (e.target.classList.contains('approve-lab-button')) {
                const reportId = e.target.dataset.id;
                if (state.reports.laboratory_reports[reportId]) {
                    state.reports.laboratory_reports[reportId].approved = true;
                    saveToStorage();
                    updateLabReportsTable();
                    showMessage('ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            }
            
            if (e.target.classList.contains('delete-lab-button')) {
                const reportId = e.target.dataset.id;
                if (state.reports.laboratory_reports[reportId]) {
                    delete state.reports.laboratory_reports[reportId];
                    saveToStorage();
                    updateLabReportsTable();
                    showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            }
            
            if (e.target.classList.contains('edit-lab-button')) {
                const reportId = e.target.dataset.id;
                const report = state.reports.laboratory_reports[reportId];
                if (report) {
                    const row = e.target.closest('tr');
                    row.innerHTML = `
                        <td class="p-1 border border-gray-400 w-16 text-center">${Array.from(row.parentNode.children).indexOf(row) + 1}</td>
                        <td class="p-0 border border-gray-400">
                            <input type="text" value="${report.data.owner || ''}" class="table-input text-sm">
                        </td>
                        <td class="p-0 border border-gray-400">
                            <input type="text" value="${report.data.phone || ''}" class="table-input text-sm">
                        </td>
                        <td class="p-0 border border-gray-400">
                            <select class="table-input text-sm">
                                <option value="">-- Ø§Ø®ØªØ± --</option>
                                ${state.config.labAnimalTypes.map(type => `<option value="${type}" ${report.data.animalType === type ? 'selected' : ''}>${type}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-0 border border-gray-400">
                            <select class="table-input text-sm">
                                <option value="">-- Ø§Ø®ØªØ± --</option>
                                ${state.config.labAnimalGenders.map(gender => `<option value="${gender}" ${report.data.animalGender === gender ? 'selected' : ''}>${gender}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-0 border border-gray-400">
                            <select class="table-input text-sm">
                                <option value="">-- Ø§Ø®ØªØ± --</option>
                                ${state.config.labSuspicions.map(suspicion => `<option value="${suspicion}" ${report.data.suspicion === suspicion ? 'selected' : ''}>${suspicion}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-0 border border-gray-400">
                            <select class="table-input text-sm">
                                <option value="">-- Ø§Ø®ØªØ± --</option>
                                ${state.config.labTests.map(test => `<option value="${test}" ${report.data.test === test ? 'selected' : ''}>${test}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-0 border border-gray-400">
                            <select class="table-input text-sm">
                                <option value="">-- Ø§Ø®ØªØ± --</option>
                                ${state.config.labResults.map(result => `<option value="${result}" ${report.data.result === result ? 'selected' : ''}>${result}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-0 border border-gray-400">
                            <select class="table-input text-sm">
                                <option value="">-- Ø§Ø®ØªØ± --</option>
                                ${state.config.labJudgments.map(judgment => `<option value="${judgment}" ${report.data.judgment === judgment ? 'selected' : ''}>${judgment}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-0 border border-gray-400">
                            <input type="date" value="${report.date || ''}" class="table-input text-sm">
                        </td>
                        <td class="p-1 border border-gray-400 text-center">
                            <button class="save-edit-button bg-green-500 text-white p-1 rounded text-xs mr-1" data-id="${reportId}">Ø­ÙØ¸</button>
                            <button class="cancel-edit-button bg-gray-500 text-white p-1 rounded text-xs" data-id="${reportId}">Ø¥Ù„ØºØ§Ø¡</button>
                        </td>
                    `;
                    
                    row.querySelector('.save-edit-button').addEventListener('click', function() {
                        const inputs = row.querySelectorAll('input, select');
                        const updatedData = {};
                        inputs.forEach((input, index) => {
                            const field = ['owner', 'phone', 'animalType', 'animalGender', 'suspicion', 'test', 'result', 'judgment', 'date'][index];
                            if (field) {
                                updatedData[field] = input.value;
                            }
                        });
                        
                        state.reports.laboratory_reports[reportId].data = updatedData;
                        state.reports.laboratory_reports[reportId].date = updatedData.date;
                        saveToStorage();
                        updateLabReportsTable();
                        showMessage('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                    });
                    
                    row.querySelector('.cancel-edit-button').addEventListener('click', function() {
                        updateLabReportsTable();
                    });
                }
            }
        }

        // ğŸ”¥ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø¯ÙŠØ± (Ø¥Ø¶Ø§ÙØ© Ø±Ù…ÙˆØ² Ø¬Ø¯ÙŠØ¯Ø©)
        async function addNewAccessCode(newCode) {
            if (!state.isAdmin) {
                showMessage("Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø±Ù…ÙˆØ² Ø¬Ø¯ÙŠØ¯Ø©", "error");
                return;
            }

            try {
                await db.collection('accessCodes').doc(newCode).set({
                    isActive: true,
                    createdAt: new Date().toISOString(),
                    createdBy: '70062'
                });
                showMessage(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ù…Ø² ${newCode} Ø¨Ù†Ø¬Ø§Ø­`, "success");
            } catch (error) {
                console.error("Error adding access code:", error);
                showMessage("ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ù…Ø²", "error");
            }
        }

        async function deleteAccessCode(code) {
            if (!state.isAdmin) {
                showMessage("Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø§Ù„Ø±Ù…ÙˆØ²", "error");
                return;
            }

            try {
                await db.collection('accessCodes').doc(code).delete();
                showMessage(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ù…Ø² ${code} Ø¨Ù†Ø¬Ø§Ø­`, "success");
            } catch (error) {
                console.error("Error deleting access code:", error);
                showMessage("ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±Ù…Ø²", "error");
            }
        }

        // ğŸ”¥ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ù…Ù† Firebase
        async function loadAccessCodesList() {
            try {
                const snapshot = await db.collection('accessCodes').get();
                const codesList = document.getElementById('access-codes-list');
                
                if (snapshot.empty) {
                    codesList.innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ù…ÙˆØ² Ù…Ø³Ø¬Ù„Ø©</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="flex justify-between items-center p-2 border-b last:border-b-0">
                            <span class="font-semibold">${doc.id} 
                                <span class="text-sm text-green-600">(${data.isActive ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'})</span>
                            </span>
                            ${doc.id !== '70062' ? `
                                <button data-code="${doc.id}" class="delete-access-code text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                            ` : '<span class="text-gray-400">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</span>'}
                        </div>
                    `;
                });
                
                codesList.innerHTML = html;

                // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
                codesList.querySelectorAll('.delete-access-code').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const codeToDelete = e.target.dataset.code;
                        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø±Ù…Ø² ${codeToDelete}ØŸ`)) {
                            await deleteAccessCode(codeToDelete);
                            loadAccessCodesList();
                        }
                    });
                });

            } catch (error) {
                console.error("Error loading access codes:", error);
                document.getElementById('access-codes-list').innerHTML = '<p class="text-red-500 text-center">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ²</p>';
            }
        }

        function renderSettingsScreen() {
            const screen = document.getElementById('settings-screen');
            if (!state.isAdmin) {
                screen.innerHTML = '<p class="text-2xl text-red-600 font-bold text-center mt-20">Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø©.</p>';
                return;
            }

            function renderPointsSettings(title, configKey, type) {
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-4">
                        <h3 class="text-xl font-semibold mb-4">${title}</h3>
                        <div id="${type}-points-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto border p-2 rounded-lg bg-gray-50">
                            ${state.config[configKey].map(point => `
                                <div class="flex justify-between items-center p-1 border-b last:border-b-0">
                                    <span>${point}</span>
                                    <button data-point="${point}" data-type="${type}" class="delete-point text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex space-x-2 space-x-reverse mt-4">
                            <input type="text" id="new-${type}-point-input" placeholder="Ø£Ø¯Ø®Ù„ Ù†Ù‚Ø·Ø© ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯Ø©" class="p-2 border rounded-lg flex-grow">
                            <button id="add${type.charAt(0).toUpperCase() + type.slice(1)}Point" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                    </div>
                `;
            }

            screen.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…)</h2>
                <div class="space-y-4">
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø±Ù…ÙˆØ² Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                        <div class="flex space-x-4 space-x-reverse mb-4">
                            <input type="text" id="new-access-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯" class="p-3 border rounded-lg flex-grow">
                            <button id="addAccessCode" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700">Ø¥Ø¶Ø§ÙØ© Ø±Ù…Ø²</button>
                        </div>
                        <h4 class="text-lg font-semibold mb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù†Ø´Ø·Ø©:</h4>
                        <div id="access-codes-list" class="space-y-2 border p-3 rounded-lg bg-gray-50">
                            <p class="text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ²...</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³Ù„Ø®</h3>
                        <div class="flex space-x-4 space-x-reverse mb-4">
                            <input type="text" id="abattoir-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ù„Ø® Ø§Ù„Ø¬Ø¯ÙŠØ¯" class="p-3 border rounded-lg flex-grow">
                            <input type="text" id="abattoir-code-input" placeholder="Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ù„Ø® (ID)" class="p-3 border rounded-lg w-40">
                            <button id="addAbattoir" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700">Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ù„Ø®</button>
                        </div>
                        <h4 class="text-lg font-semibold mb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ù„Ø® Ø§Ù„Ù…Ø¹Ø±ÙØ©:</h4>
                        <div id="abattoir-list" class="space-y-2 border p-3 rounded-lg bg-gray-50">
                            ${state.config.abattoirs.map(abattoir => `
                                <div class="flex justify-between items-center p-2 border-b last:border-b-0">
                                    <span class="font-semibold">${abattoir.name} (<span class="text-blue-600">${abattoir.id}</span>)</span>
                                    <button data-id="${abattoir.id}" class="delete-abattoir text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Ø¥Ø¹Ø¯Ø§Ø¯ ØµÙˆØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold mb-2">ØµÙˆØ±Ø© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ (Splash)</h4>
                                <input type="file" id="splash-file-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">ØµÙˆØ±Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Unified)</h4>
                                <input type="file" id="unified-file-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                            </div>
                        </div>
                    </div>

                    ${renderPointsSettings('Ù†Ù‚Ø§Ø· Ù‚ÙŠØ§Ø³ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø©', 'tempPoints', 'temp')}
                    ${renderPointsSettings('Ù†Ù‚Ø§Ø· ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø¸Ø§ÙØ©', 'cleaningPoints', 'cleaning')}
                    ${renderPointsSettings('Ù†Ù‚Ø§Ø· ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØµÙŠØ§Ù†Ø©', 'maintenancePoints', 'maintenance')}

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</h4>
                                <div class="space-y-2 border p-2 rounded-lg bg-gray-50 max-h-40 overflow-y-auto">
                                    ${state.config.labAnimalTypes.map(type => `
                                        <div class="flex justify-between items-center p-1 border-b last:border-b-0">
                                            <span>${type}</span>
                                            <button data-type="labAnimalTypes" data-value="${type}" class="delete-lab-item text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex space-x-2 space-x-reverse mt-2">
                                    <input type="text" id="new-animal-type-input" placeholder="Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯" class="p-2 border rounded-lg flex-grow">
                                    <button id="addAnimalType" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700">Ø¥Ø¶Ø§ÙØ©</button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Ø¬Ù†Ø³ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</h4>
                                <div class="space-y-2 border p-2 rounded-lg bg-gray-50 max-h-40 overflow-y-auto">
                                    ${state.config.labAnimalGenders.map(gender => `
                                        <div class="flex justify-between items-center p-1 border-b last:border-b-0">
                                            <span>${gender}</span>
                                            <button data-type="labAnimalGenders" data-value="${gender}" class="delete-lab-item text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex space-x-2 space-x-reverse mt-2">
                                    <input type="text" id="new-animal-gender-input" placeholder="Ø¬Ù†Ø³ Ø¬Ø¯ÙŠØ¯" class="p-2 border rounded-lg flex-grow">
                                    <button id="addAnimalGender" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700">Ø¥Ø¶Ø§ÙØ©</button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§Ø´ØªØ¨Ø§Ù‡</h4>
                                <div class="space-y-2 border p-2 rounded-lg bg-gray-50 max-h-40 overflow-y-auto">
                                    ${state.config.labSuspicions.map(suspicion => `
                                        <div class="flex justify-between items-center p-1 border-b last:border-b-0">
                                            <span>${suspicion}</span>
                                            <button data-type="labSuspicions" data-value="${suspicion}" class="delete-lab-item text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex space-x-2 space-x-reverse mt-2">
                                    <input type="text" id="new-suspicion-input" placeholder="Ø§Ø´ØªØ¨Ø§Ù‡ Ø¬Ø¯ÙŠØ¯" class="p-2 border rounded-lg flex-grow">
                                    <button id="addSuspicion" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700">Ø¥Ø¶Ø§ÙØ©</button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h4>
                                <div class="space-y-2 border p-2 rounded-lg bg-gray-50 max-h-40 overflow-y-auto">
                                    ${state.config.labTests.map(test => `
                                        <div class="flex justify-between items-center p-1 border-b last:border-b-0">
                                            <span>${test}</span>
                                            <button data-type="labTests" data-value="${test}" class="delete-lab-item text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex space-x-2 space-x-reverse mt-2">
                                    <input type="text" id="new-test-input" placeholder="Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯" class="p-2 border rounded-lg flex-grow">
                                    <button id="addTest" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700">Ø¥Ø¶Ø§ÙØ©</button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h4>
                                <div class="space-y-2 border p-2 rounded-lg bg-gray-50 max-h-40 overflow-y-auto">
                                    ${state.config.labResults.map(result => `
                                        <div class="flex justify-between items-center p-1 border-b last:border-b-0">
                                            <span>${result}</span>
                                            <button data-type="labResults" data-value="${result}" class="delete-lab-item text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex space-x-2 space-x-reverse mt-2">
                                    <input type="text" id="new-result-input" placeholder="Ù†ØªÙŠØ¬Ø© Ø¬Ø¯ÙŠØ¯Ø©" class="p-2 border rounded-lg flex-grow">
                                    <button id="addResult" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700">Ø¥Ø¶Ø§ÙØ©</button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">Ø§Ù„Ø£Ø­ÙƒØ§Ù…</h4>
                                <div class="space-y-2 border p-2 rounded-lg bg-gray-50 max-h-40 overflow-y-auto">
                                    ${state.config.labJudgments.map(judgment => `
                                        <div class="flex justify-between items-center p-1 border-b last:border-b-0">
                                            <span>${judgment}</span>
                                            <button data-type="labJudgments" data-value="${judgment}" class="delete-lab-item text-red-500 hover:text-red-700">Ø­Ø°Ù</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex space-x-2 space-x-reverse mt-2">
                                    <input type="text" id="new-judgment-input" placeholder="Ø­ÙƒÙ… Ø¬Ø¯ÙŠØ¯" class="p-2 border rounded-lg flex-grow">
                                    <button id="addJudgment" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700">Ø¥Ø¶Ø§ÙØ©</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ù…Ù† Firebase
            loadAccessCodesList();

            document.getElementById('addAccessCode').addEventListener('click', async () => {
                const newCode = document.getElementById('new-access-code-input').value.trim();
                if (newCode) {
                    await addNewAccessCode(newCode);
                    document.getElementById('new-access-code-input').value = '';
                    loadAccessCodesList();
                }
            });

            document.getElementById('addAbattoir').addEventListener('click', addAbattoirHandler);
            screen.querySelectorAll('.delete-abattoir').forEach(btn => btn.addEventListener('click', deleteAbattoirHandler));

            document.getElementById('splash-file-input').addEventListener('change', (e) => handleImageUpload(e, 'splashImageUrl', dom.splashImageDisplay) );
            document.getElementById('unified-file-input').addEventListener('change', (e) => handleImageUpload(e, 'unifiedImageUrl', dom.sidebarImageDisplay) );

            document.getElementById('addTempPoint').addEventListener('click', () => addPointHandler('temp'));
            document.getElementById('addCleaningPoint').addEventListener('click', () => addPointHandler('cleaning'));
            document.getElementById('addMaintenancePoint').addEventListener('click', () => addPointHandler('maintenance'));
            screen.querySelectorAll('.delete-point').forEach(btn => btn.addEventListener('click', deletePointHandler));

            document.getElementById('addAnimalType').addEventListener('click', () => addLabItemHandler('labAnimalTypes', 'new-animal-type-input'));
            document.getElementById('addAnimalGender').addEventListener('click', () => addLabItemHandler('labAnimalGenders', 'new-animal-gender-input'));
            document.getElementById('addSuspicion').addEventListener('click', () => addLabItemHandler('labSuspicions', 'new-suspicion-input'));
            document.getElementById('addTest').addEventListener('click', () => addLabItemHandler('labTests', 'new-test-input'));
            document.getElementById('addResult').addEventListener('click', () => addLabItemHandler('labResults', 'new-result-input'));
            document.getElementById('addJudgment').addEventListener('click', () => addLabItemHandler('labJudgments', 'new-judgment-input'));
            screen.querySelectorAll('.delete-lab-item').forEach(btn => btn.addEventListener('click', deleteLabItemHandler));
        }
        
        function addAbattoirHandler() {
            const nameInput = document.getElementById('abattoir-name-input');
            const codeInput = document.getElementById('abattoir-code-input');
            const name = nameInput.value.trim();
            const id = codeInput.value.trim();

            if (!name || !id) {
                showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ±Ù…Ø² Ø§Ù„Ù…Ø³Ù„Ø®.', 'error');
                return;
            }
            if (state.config.abattoirs.find(a => a.id === id)) {
                showMessage('Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ù„Ø® Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.', 'error');
                return;
            }

            state.config.abattoirs.push({ id, name });
            saveToStorage();
            showMessage(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ù„Ø® ${name} Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
            nameInput.value = '';
            codeInput.value = '';
            renderSettingsScreen();
        }

        function deleteAbattoirHandler(e) {
            const idToDelete = e.target.dataset.id;
            
            state.config.abattoirs = state.config.abattoirs.filter(a => a.id !== idToDelete);
            saveToStorage();
            showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³Ù„Ø® Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            renderSettingsScreen();
        }

        function addPointHandler(type) {
            const inputId = `new-${type}-point-input`;
            const input = document.getElementById(inputId);
            const point = input.value.trim();
            const configKey = `${type}Points`;

            if (!point) {
                showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ….', 'error');
                return;
            }

            if (state.config[configKey].includes(point)) {
                showMessage('Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ù‡ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹.', 'error');
                return;
            }

            state.config[configKey].push(point);
            saveToStorage();
            showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            input.value = '';
            renderSettingsScreen(); 
        }

        function deletePointHandler(e) {
            const pointToDelete = e.target.dataset.point;
            const type = e.target.dataset.type;
            const configKey = `${type}Points`;

            state.config[configKey] = state.config[configKey].filter(p => p !== pointToDelete);
            saveToStorage();
            showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
            renderSettingsScreen(); 
        }

        function addLabItemHandler(configKey, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();

            if (!value) {
                showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø©.', 'error');
                return;
            }

            if (state.config[configKey].includes(value)) {
                showMessage('Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹.', 'error');
                return;
            }

            state.config[configKey].push(value);
            saveToStorage();
            showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            input.value = '';
            renderSettingsScreen();
        }

        function deleteLabItemHandler(e) {
            const valueToDelete = e.target.dataset.value;
            const configKey = e.target.dataset.type;

            state.config[configKey] = state.config[configKey].filter(v => v !== valueToDelete);
            saveToStorage();
            showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­.');
            renderSettingsScreen();
        }

        window.onload = setupAppAndLoad;

        window.addEventListener('keydown', function(e) {
            if (e.key === 'F5') {
                e.preventDefault();
                if (state.currentScreen) {
                    renderScreen(state.currentScreen);
                }
            }
        });

        dom.loginButton.addEventListener('click', () => {
            handleLogin(dom.abattoirCodeInput.value.trim());
        });
        
        dom.abattoirCodeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleLogin(dom.abattoirCodeInput.value.trim());
            }
        });

        dom.logoutButton.addEventListener('click', handleLogout);

        document.querySelectorAll('.menu-item').forEach(button => {
            button.addEventListener('click', (e) => {
                const screenName = e.target.dataset.screen;
                if (screenName === 'settings' && !state.isAdmin) {
                    showMessage('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'error');
                    return;
                }
                renderScreen(screenName);
            });
        });

        dom.backButton.addEventListener('click', () => renderScreen('dashboard'));

    </script>
</body>
</html>
